# ğŸ©¸ Phase 3: Flesh - External Integrations

## ğŸ¯ Mission
**"ì™¸ë¶€ PGÂ·WebSocketÂ·AnalyticsÂ·Notification ë“± 2ì°¨ ì—°ê²°ê³ ë¦¬ë¥¼ ë¶™ì—¬ ì‹¤ì œ ì‚¬ìš©ê° í™•ë³´"**

Phase 2ì—ì„œ êµ¬ì¶•ëœ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìœ„ì— ì™¸ë¶€ ì„œë¹„ìŠ¤ë“¤ì„ ì—°ë™í•˜ì—¬ ì‹¤ì œ ìš´ì˜ ê°€ëŠ¥í•œ ì‹œìŠ¤í…œì„ ë§Œë“­ë‹ˆë‹¤.

---

## âœ… Phase 3 Checklist

### ğŸ¯ Critical Success Criteria (Must Complete)
- [ ] í† ìŠ¤Â·ì¹´ì¹´ì˜¤í˜ì´ ì‹¤ì œ API ì—°ë™ ë° ê²°ì œ í”„ë¡œì„¸ìŠ¤ ì™„ì„±
- [ ] WebSocket ì‹¤ì‹œê°„ ì£¼ë¬¸/ì”ì•¡ ì—…ë°ì´íŠ¸ ì‹œìŠ¤í…œ
- [ ] Google Analytics 4 + Mixpanel ë¶„ì„ ì—°ë™
- [ ] ì´ë©”ì¼/SMS ì•Œë¦¼ ì„œë¹„ìŠ¤ ì—°ë™
- [ ] SNS í”Œë«í¼ API ì—°ë™ (Instagram, YouTube, TikTok)

### ğŸ”§ Payment Gateway Integration

#### Toss Payments Implementation
- [ ] **Toss Payments API ì—°ë™**
  - ê²°ì œ ìš”ì²­ API êµ¬í˜„
  - ê²°ì œ ìŠ¹ì¸ ì²˜ë¦¬
  - ê²°ì œ ì‹¤íŒ¨/ì·¨ì†Œ ì²˜ë¦¬
  - ë¶€ë¶„ ì·¨ì†Œ ê¸°ëŠ¥

- [ ] **Payment Webhook êµ¬í˜„**
  - ê²°ì œ ì™„ë£Œ Webhook ìˆ˜ì‹ 
  - ì”ì•¡ ìë™ ì¶©ì „ ì²˜ë¦¬
  - ê²°ì œ ìƒíƒœ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
  - ê±°ë˜ ë‚´ì—­ ìë™ ìƒì„±

#### KakaoPay Integration
- [ ] **ì¹´ì¹´ì˜¤í˜ì´ API ì—°ë™**
  - ê²°ì œ ì¤€ë¹„/ìŠ¹ì¸ API
  - QR ì½”ë“œ ê²°ì œ ì§€ì›
  - ì •ê¸° ê²°ì œ ì„¤ì • (ì„ íƒì‚¬í•­)
  - í™˜ë¶ˆ ì²˜ë¦¬ ì‹œìŠ¤í…œ

### ğŸ”§ Real-time Features Implementation

#### WebSocket System
- [ ] **ì‹¤ì‹œê°„ ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸**
  - ì£¼ë¬¸ ìƒì„±/ì§„í–‰/ì™„ë£Œ ì•Œë¦¼
  - ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì‹¤ì‹œê°„ ë°˜ì˜
  - ê´€ë¦¬ì ì£¼ë¬¸ ëª¨ë‹ˆí„°ë§

- [ ] **ì‹¤ì‹œê°„ ì”ì•¡ ì—…ë°ì´íŠ¸**
  - ê²°ì œ ì™„ë£Œ ì‹œ ì¦‰ì‹œ ì”ì•¡ ë°˜ì˜
  - ì£¼ë¬¸ ì°¨ê° ì¦‰ì‹œ ì—…ë°ì´íŠ¸
  - í™˜ë¶ˆ ì²˜ë¦¬ ì‹¤ì‹œê°„ ë°˜ì˜

- [ ] **ì‹¤ì‹œê°„ ì•Œë¦¼ ì‹œìŠ¤í…œ**
  - ì‹œìŠ¤í…œ ê³µì§€ì‚¬í•­ Push
  - ì‚¬ìš©ìë³„ ê°œì¸í™” ì•Œë¦¼
  - ê´€ë¦¬ì ì•Œë¦¼ (ì˜¤ë¥˜, ì´ìƒ ê±°ë˜ ë“±)

### ğŸ”§ Analytics & Monitoring Integration

#### Google Analytics 4
- [ ] **GA4 ì—°ë™ êµ¬í˜„**
  - í˜ì´ì§€ ë·° ì¶”ì 
  - ì‚¬ìš©ì ì´ë²¤íŠ¸ ë¶„ì„
  - ì£¼ë¬¸ ì „í™˜ìœ¨ ì¶”ì 
  - ë§ì¶¤ ì´ë²¤íŠ¸ ì„¤ì •

#### Mixpanel Analytics
- [ ] **ì‚¬ìš©ì í–‰ë™ ë¶„ì„**
  - ì„œë¹„ìŠ¤ ì´ìš© íŒ¨í„´ ë¶„ì„
  - ì£¼ë¬¸ ê³¼ì • Funnel ë¶„ì„
  - ì‚¬ìš©ì Cohort ë¶„ì„
  - A/B í…ŒìŠ¤íŠ¸ ê¸°ë°˜ êµ¬ì¶•

### ğŸ”§ Communication & Notification

#### Email Service Integration
- [ ] **ì´ë©”ì¼ ì„œë¹„ìŠ¤ ì—°ë™ (Postmark/SendGrid)**
  - íšŒì›ê°€ì…/ë¡œê·¸ì¸ ì¸ì¦ ì´ë©”ì¼
  - ì£¼ë¬¸ ì™„ë£Œ/ìƒíƒœ ë³€ê²½ ì•Œë¦¼
  - ê²°ì œ/í™˜ë¶ˆ ì˜ìˆ˜ì¦ ë°œì†¡
  - ë§ˆì¼€íŒ… ì´ë©”ì¼ (ì„ íƒì‚¬í•­)

#### SMS Notification (ì„ íƒì‚¬í•­)
- [ ] **SMS ì•Œë¦¼ ì„œë¹„ìŠ¤**
  - ì¤‘ìš” ê±°ë˜ SMS ì•Œë¦¼
  - ë³´ì•ˆ ê´€ë ¨ SMS ì¸ì¦
  - ì£¼ë¬¸ ì™„ë£Œ SMS ì•Œë¦¼

### ğŸ”§ SNS Platform API Integration

#### Instagram Business API
- [ ] **Instagram API ì—°ë™**
  - ê³„ì • ì •ë³´ ê²€ì¦
  - íŒ”ë¡œì›Œ ìˆ˜ ì‹¤ì‹œê°„ í™•ì¸
  - ê²Œì‹œë¬¼ ë¶„ì„ ë°ì´í„°
  - API ì œí•œ ê´€ë¦¬

#### YouTube Data API
- [ ] **YouTube API ì—°ë™**
  - ì±„ë„ ì •ë³´ í™•ì¸
  - êµ¬ë…ì ìˆ˜ ê²€ì¦
  - ì¡°íšŒìˆ˜ ë°ì´í„° ìˆ˜ì§‘
  - API ì¿¼í„° ê´€ë¦¬

#### TikTok Business API (ì„ íƒì‚¬í•­)
- [ ] **TikTok API ì—°ë™**
  - ê³„ì • ì •ë³´ í™•ì¸
  - íŒ”ë¡œì›Œ ë°ì´í„° ìˆ˜ì§‘
  - ì˜ìƒ ë¶„ì„ ì •ë³´

---

## ğŸ”§ Implementation Guide

### 1. Toss Payments Integration

#### Backend - Payment Service
```typescript
// src/services/paymentService.ts
import axios from 'axios';

export class TossPaymentService {
  private readonly API_URL = 'https://api.tosspayments.com/v1';
  private readonly SECRET_KEY = process.env.TOSS_PAY_SECRET_KEY;

  async requestPayment(paymentData: PaymentRequest): Promise<PaymentResponse> {
    try {
      const response = await axios.post(`${this.API_URL}/payments`, {
        amount: paymentData.amount,
        orderId: paymentData.orderId,
        orderName: paymentData.orderName,
        customerEmail: paymentData.customerEmail,
        successUrl: `${process.env.FRONTEND_URL}/payment/success`,
        failUrl: `${process.env.FRONTEND_URL}/payment/fail`
      }, {
        headers: {
          'Authorization': `Basic ${Buffer.from(this.SECRET_KEY + ':').toString('base64')}`,
          'Content-Type': 'application/json'
        }
      });

      return response.data;
    } catch (error) {
      throw new Error(`Payment request failed: ${error.message}`);
    }
  }

  async handleWebhook(webhookData: any): Promise<void> {
    // ê²°ì œ ì™„ë£Œ ì²˜ë¦¬
    await prisma.payment.create({
      data: {
        transactionId: webhookData.paymentKey,
        amount: webhookData.totalAmount,
        status: 'COMPLETED',
        userId: webhookData.metadata.userId
      }
    });

    // ì‚¬ìš©ì ì”ì•¡ ì—…ë°ì´íŠ¸
    await prisma.user.update({
      where: { id: webhookData.metadata.userId },
      data: { balance: { increment: webhookData.totalAmount } }
    });

    // ì‹¤ì‹œê°„ ì•Œë¦¼
    this.socketService.emitBalanceUpdate(
      webhookData.metadata.userId,
      webhookData.totalAmount
    );
  }
}
```

#### Frontend - Payment Integration
```typescript
// src/services/payment.ts
import { loadTossPayments } from '@tosspayments/payment-sdk';

export class PaymentService {
  private tossPayments: any;

  async initialize(): Promise<void> {
    this.tossPayments = await loadTossPayments(process.env.VITE_TOSSPAY_CLIENT_KEY);
  }

  async requestPayment(amount: number, orderId: string): Promise<void> {
    await this.tossPayments.requestPayment('ì¹´ë“œ', {
      amount,
      orderId,
      orderName: `Instaup ì”ì•¡ ì¶©ì „ ${amount.toLocaleString()}ì›`,
      customerName: 'ì‚¬ìš©ì',
      successUrl: `${window.location.origin}/payment/success`,
      failUrl: `${window.location.origin}/payment/fail`,
    });
  }
}
```

### 2. WebSocket Real-time Implementation

#### Backend - Socket Service
```typescript
// src/services/socketService.ts
import { Server } from 'socket.io';

export class SocketService {
  private io: Server;

  constructor(server: any) {
    this.io = new Server(server, {
      cors: {
        origin: process.env.CORS_ORIGIN,
        methods: ['GET', 'POST']
      }
    });

    this.setupEventHandlers();
  }

  private setupEventHandlers(): void {
    this.io.on('connection', (socket) => {
      socket.on('join', (userId: string) => {
        socket.join(`user_${userId}`);
      });

      socket.on('disconnect', () => {
        console.log('User disconnected');
      });
    });
  }

  emitOrderUpdate(userId: string, orderData: any): void {
    this.io.to(`user_${userId}`).emit('orderUpdate', orderData);
  }

  emitBalanceUpdate(userId: string, newBalance: number): void {
    this.io.to(`user_${userId}`).emit('balanceUpdate', { balance: newBalance });
  }

  emitSystemNotification(message: string): void {
    this.io.emit('systemNotification', { message, timestamp: Date.now() });
  }
}
```

#### Frontend - Socket Integration
```typescript
// src/hooks/useSocket.ts
import { useEffect, useContext } from 'react';
import { io, Socket } from 'socket.io-client';
import { AuthContext } from '../contexts/AuthContext';

export const useSocket = () => {
  const { user } = useContext(AuthContext);
  const [socket, setSocket] = useState<Socket | null>(null);

  useEffect(() => {
    if (user) {
      const newSocket = io(process.env.VITE_BACKEND_API_URL);

      newSocket.emit('join', user.id);

      newSocket.on('orderUpdate', (orderData) => {
        // ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
        toast.success(`ì£¼ë¬¸ ìƒíƒœê°€ ${orderData.status}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      });

      newSocket.on('balanceUpdate', ({ balance }) => {
        // ì”ì•¡ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
        updateUserBalance(balance);
      });

      setSocket(newSocket);

      return () => newSocket.close();
    }
  }, [user]);

  return socket;
};
```

### 3. Analytics Integration

#### Google Analytics 4 Setup
```typescript
// src/services/analytics.ts
import ReactGA from 'react-ga4';

export class AnalyticsService {
  initialize(): void {
    ReactGA.initialize(process.env.VITE_GA_MEASUREMENT_ID);
  }

  trackEvent(action: string, category: string, label?: string): void {
    ReactGA.event({
      action,
      category,
      label
    });
  }

  trackPurchase(transactionId: string, value: number): void {
    ReactGA.event('purchase', {
      transaction_id: transactionId,
      value,
      currency: 'KRW'
    });
  }

  trackOrderCreated(orderId: string, serviceType: string, amount: number): void {
    this.trackEvent('order_created', 'engagement', serviceType);
    this.trackPurchase(orderId, amount);
  }
}
```

### 4. Email Service Integration

#### Backend - Email Service
```typescript
// src/services/emailService.ts
import { Client } from 'postmark';

export class EmailService {
  private client: Client;

  constructor() {
    this.client = new Client(process.env.POSTMARK_API_KEY);
  }

  async sendOrderConfirmation(email: string, orderData: any): Promise<void> {
    await this.client.sendEmailWithTemplate({
      From: 'noreply@instaup.com',
      To: email,
      TemplateAlias: 'order-confirmation',
      TemplateModel: {
        orderNumber: orderData.id,
        serviceName: orderData.service.name,
        quantity: orderData.quantity,
        totalAmount: orderData.totalAmount,
        orderDate: new Date(orderData.createdAt).toLocaleDateString('ko-KR')
      }
    });
  }

  async sendPaymentReceipt(email: string, paymentData: any): Promise<void> {
    await this.client.sendEmailWithTemplate({
      From: 'noreply@instaup.com',
      To: email,
      TemplateAlias: 'payment-receipt',
      TemplateModel: {
        transactionId: paymentData.transactionId,
        amount: paymentData.amount,
        paymentMethod: paymentData.method,
        paymentDate: new Date(paymentData.createdAt).toLocaleDateString('ko-KR')
      }
    });
  }
}
```

---

## ğŸ§ª Testing & Verification

### Payment Integration Testing
```bash
# Test payment webhook (using ngrok for local testing)
curl -X POST https://your-ngrok-url.ngrok.io/webhook/payment \
  -H "Content-Type: application/json" \
  -d '{
    "paymentKey": "test_payment_123",
    "orderId": "order_123",
    "totalAmount": 10000,
    "status": "DONE",
    "metadata": { "userId": "user_123" }
  }'
```

### WebSocket Testing
```javascript
// Browser console test
const socket = io('http://localhost:3000');
socket.emit('join', 'user_123');
socket.on('orderUpdate', (data) => console.log('Order update:', data));
socket.on('balanceUpdate', (data) => console.log('Balance update:', data));
```

### Analytics Verification
- [ ] Google Analytics ì‹¤ì‹œê°„ ë°ì´í„° í™•ì¸
- [ ] Mixpanel ì´ë²¤íŠ¸ ì¶”ì  í™•ì¸
- [ ] ì£¼ë¬¸ ì „í™˜ Funnel ë°ì´í„° ê²€ì¦

---

## ğŸ“Š Phase 3 Success Metrics

| Feature | Target | Verification Method |
|---------|--------|-------------------|
| Payment Success Rate | > 95% | Payment logs analysis |
| Real-time Message Delivery | < 1s | WebSocket latency monitoring |
| Analytics Data Accuracy | > 99% | Cross-platform verification |
| Email Delivery Rate | > 98% | Email service metrics |
| API Integration Uptime | > 99.5% | External API monitoring |

---

## ğŸ‰ Phase 3 ì™„ë£Œ ê¸°ì¤€

**ë‹¤ìŒ ì¡°ê±´ë“¤ì´ ëª¨ë‘ ë§Œì¡±ë˜ë©´ Phase 4ë¡œ ì§„í–‰:**

1. âœ… ì‹¤ì œ ê²°ì œê°€ ì²˜ë¦¬ë˜ê³  ì”ì•¡ì´ ìë™ìœ¼ë¡œ ì¶©ì „ë¨
2. âœ… ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ì‚¬ìš©ìì—ê²Œ ì „ë‹¬ë¨
3. âœ… ëª¨ë“  ì‚¬ìš©ì í–‰ë™ì´ Analyticsì— ì •í™•íˆ ê¸°ë¡ë¨
4. âœ… ì´ë©”ì¼ ì•Œë¦¼ì´ ì ì ˆí•œ íƒ€ì´ë°ì— ë°œì†¡ë¨
5. âœ… ì™¸ë¶€ API ì—°ë™ì´ ì•ˆì •ì ìœ¼ë¡œ ì‘ë™í•¨

---

## ğŸ”„ Next Steps (Phase 4 Preview)

Phase 3ì´ ì™„ë£Œë˜ë©´ ë‹¤ìŒ ì‘ì—…ë“¤ì„ ì¤€ë¹„í•˜ì„¸ìš”:
- E2E í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ êµ¬í˜„
- ì„±ëŠ¥ ìµœì í™” ë° ëª¨ë‹ˆí„°ë§
- ë³´ì•ˆ ê°•í™” ë° ê°ì‚¬
- í”„ë¡œë•ì…˜ ë°°í¬ ìµœì í™”

---

*Phase 3 Implementation Guide - Last Updated: 2025-06-20*
